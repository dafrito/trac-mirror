<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="layout.html" />
  <xi:include href="macros.html" />

  <head>
    <title>
      <py:choose>
        <py:when test="ticket.id">
          #${ticket.id} (${ticket.summary})
        </py:when>
        <py:otherwise>
          New Ticket
        </py:otherwise>
      </py:choose>
    </title>
    <script type="text/javascript" src="${chrome.htdocs_location}js/wikitoolbar.js"></script>
    <script type="text/javascript" py:choose="">
      $(document).ready(function() {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor("Link to this section");
      <py:when test="ticket.id">
        $("#changelog h3.change").addAnchor("Link to this change");
        function updateActionFields() {
          $("#resolve_choice").enable($("#resolve").checked());
          $("#reassign_choice").enable($("#reassign").checked());
        }
        $("#action input[@name='action']").click(updateActionFields);
        updateActionFields();
      </py:when>
      <py:otherwise>
        $(document).ready(function() {$("#field-summary").get(0).focus()});
      </py:otherwise>
      });
    </script>
  </head>

  <body>
    <div id="ctxtnav" class="nav" py:with="links = chrome.links">
      <h2>Ticket Navigation</h2>
      ${prevnext_nav('Ticket', 'Back to Query')}
    </div>

    <div id="content" class="ticket">
      <h1>
        <py:choose>
          <py:when test="ticket.id">
            <a py:strip="not version and version != 0" href="${href.ticket(ticket.id)}">
              Ticket #${ticket.id}
            </a>
          </py:when>
          <py:otherwise>
            Create New Ticket
          </py:otherwise>
        </py:choose>

        <py:if test="ticket.status">
          <span class="status">(${ticket.status} <py:if
              test="ticket.type">${ticket.type}</py:if><py:if
              test="ticket.resolution">: ${ticket.resolution}</py:if>)</span>
          <py:choose test="">
            <py:when test="not defined('version') or version is None" />
            <py:when test="version == 0">
              &mdash; at <a href="#comment:description">Initial Version</a>
            </py:when>
            <py:otherwise>
              &mdash; at <a href="#comment:$version">Version $version</a>
            </py:otherwise>
          </py:choose>
        </py:if>
      </h1>

      <!-- Do not show the ticket preview when the user first comes to the "New
           Ticket" page.  Wait until they hit preview.  ticket.status is defined if the
           ticket exists, or we are previewing a new ticket -->
      <py:if test="ticket.status">
        <!-- Ticket number, summary, etc heading -->
        <!-- Ticket (pre)view -->
        <div id="ticket" py:attrs="(('preview' in req.args) or (not ticket.id)) and {'class':'ticketdraft'} or {}">
          <div class="date">
            <p py:if="defined('opened')">Opened ${dateinfo(opened)} ago</p>
            <p py:if="defined('lastmod')">Last modified ${dateinfo(lastmod)} ago</p>
            <p py:if="not defined('opened')"><i>(future ticket)</i></p>
          </div>
          <!-- use a placeholder if it's a new ticket -->
          <h2 class="summary searchable">
            <py:choose>
              <py:when test="ticket.summary">
                ${ticket.summary}
              </py:when>
              <py:otherwise>
                <div class="system-message">ticket summary missing</div>
              </py:otherwise>
            </py:choose>
          </h2>

          <table class="properties"
                 py:with="fields = [f for f in fields if not f.get('skip')]">
            <tr>
              <th id="h_reporter">Reported by:</th>
              <td headers="h_reporter" class="searchable">${authorinfo(ticket.reporter)}</td>
              <th id="h_owner">Assigned to:</th>
              <td headers="h_owner">${authorinfo(ticket.owner)}
                <py:if test="ticket.status == 'assigned'">(accepted)</py:if>
              </td>
            </tr>
            <tr py:for="row in group(fields, 2, lambda f: f.type != 'textarea')"
                py:with="fullrow = len(row) == 1">
              <py:for each="idx, field in enumerate(row)">
                <th py:if="idx == 0 or not fullrow">
                  <py:if test="field">${field.label or field.name}:</py:if>
                </th>
                <td py:if="idx == 0 or not fullrow"
                    class="${field and field.name in ('cc', 'keywords') and 'searchable' or None}"
                    colspan="${fullrow and 3 or None}">
                  <py:if test="field">${ticket[field.name]}</py:if>
                </td>
              </py:for>
            </tr>
          </table>
          <form py:if="ticket.description" method="get" action="#comment"
                class="printableform">
            <div class="description">
              <h3 id="comment:description">
                <!-- check ticket.id; you can't reply to a ticket that does not yet exist. -->
                <span py:if="'TICKET_APPEND' in perm and ticket.id" class="inlinebuttons">
                  <input type="hidden" name="replyto" value="description" />
                  <input type="submit" name="reply" value="Reply" title="Reply, quoting this description" />
                </span>
                Description
                <span py:if="defined('description_change')" class="lastmod"
                      title="$description_change.date">
                  (last modified by ${authorinfo(description_change.author)})
                  (<a href="${href.ticket(ticket.id, action='diff', version=description_change.cnum)}">diff</a>)
                </span>
              </h3>
              <div class="searchable">
                ${wiki_to_html(context, ticket.description)}
              </div>
            </div>
          </form>
        </div>
        <!-- End of ticket (pre)view -->

        <!-- do not show attachments for old versions of this ticket or for new
          tickets -->
        <py:if test="not version and version != 0 and ticket.id">
          ${list_of_attachments(context, attachments, attach_href)}
        </py:if>

        <py:if test="changes">
          <h2>Change History</h2>
          <div id="changelog">
            <form py:for="change in changes" method="get" action="#comment"
                  class="printableform">
              <div py:attrs="change.preview and {'class':'ticketdraft', 'id':'preview'} or {'class':'change'}">
                <h3 class="change" id="${change.cnum and 'comment:%d' % change.cnum or ''}">
                  <span py:if="change.cnum and 'TICKET_APPEND' in perm" class="inlinebuttons">
                    <input type="hidden" name="replyto" value="${change.cnum}" />
                    <input type="submit" value="Reply" title="Reply to comment ${change.cnum}" />
                  </span>
                  <span class="threading" py:with="change_replies = replies[str(change.cnum)]">
                    <py:def function="commentref(prefix, cnum)">
                      <a href="#comment:$cnum"><small>$prefix$cnum</small></a>
                    </py:def>
                    <py:if test="change_replies or change.replyto">
                      <py:if test="change.replyto">
                        in reply to: ${commentref('&uarr;&nbsp;', change.replyto)}
                        <py:if test="change_replies">; </py:if>
                      </py:if>
                      <py:if test="change_replies">follow-up${len(change_replies) > 1 and 's' or ''}:
                        <py:for each="reply in change_replies">
                          ${commentref('&darr;&nbsp;', reply)}
                        </py:for></py:if>
                    </py:if>
                    &nbsp;
                  </span>
                <py:choose>
                  <py:when test="change.preview">
                    Preview of change by ${authorinfo(change.author)}
                  </py:when>
                  <py:otherwise>
                    Changed ${dateinfo(change.date)} ago by ${authorinfo(change.author)}
                  </py:otherwise>
                </py:choose>
                </h3>
                <ul py:if="change.fields" class="changes">
                  <li py:for="field_name, field in change.fields.items()"
                      py:with="filed_type = field_types[field_name]">
                    <strong>${field_name}</strong>
                    <py:choose>
                      <py:when test="field_name == 'attachment'">
                        <a href="${href.attachment('ticket', ticket.id, field.new)}"><em>${field.new}</em></a> added
                      </py:when>
                      <py:when test="field.old and field.new">
                        changed
                        <py:choose>
                          <py:when test="field_types[field_name] == 'textarea'">
                            (<a py:strip="not change.cnum" href="${href.ticket(ticket.id, action='diff', version=change.cnum)}">diff</a>)
                          </py:when>
                          <py:otherwise>
                            from <em>${field.old}</em> to <em>${field.new}</em>
                          </py:otherwise>
                        </py:choose>
                      </py:when>
                      <py:when test="not field.old and field.new">
                        set
                        <py:if test="field_types[field_name] != 'textarea'">
                          to <em>${field.new}</em>
                        </py:if>
                      </py:when>
                      <py:otherwise>deleted</py:otherwise>
                    </py:choose>
                  </li>
                </ul>
                <div py:if="change.comment" class="comment searchable">
                  ${wiki_to_html(context, change.comment)}
                </div>
              </div>
            </form>
          </div>
        </py:if>
      <!-- End of the section we don't show on initial new tickets -->
      </py:if>

      <form py:if="value_of('version') != 0 and ('TICKET_APPEND' in perm or 'TICKET_CHGPROP' in perm or ('TICKET_CREATE' in perm and not ticket.id))"
            action="#preview" method="post">
        <h3 py:if="ticket.id"><a name="edit" onfocus="$('#comment').get(0).focus()">
            Add/Change #${ticket.id} (${ticket.summary})</a></h3>
        <div py:if="authname == 'anonymous'" class="field">
          <fieldset>
            <legend>${ticket.id and 'Author' or 'Reporter'}</legend>
            <table>
              <tr>
                <th>
                  <label for="author">Your email or username:</label><br />
                </th>
                <td>
                  <input type="text" id="author" name="author" size="40" value="$author_id" />
                  <br />
                </td>
              </tr>
            </table>
          </fieldset>
        </div>
        <div py:if="ticket.id" class="field">
          <fieldset class="iefix">
            <label for="comment">Comment (you may use
              <a tabindex="42" href="${href.wiki('WikiFormatting')}">WikiFormatting</a>
              here):
            </label><br />
            <p><textarea id="comment" name="comment" class="wikitext" rows="10" cols="78">
${value_of('comment')}</textarea></p>
          </fieldset>
        </div>

        <fieldset id="properties" py:if="'TICKET_CHGPROP' in req.perm or ('TICKET_CREATE' in req.perm and not ticket.id)"
                  py:with="fields = [f for f in fields if not f.get('skip')]">
          <legend>${ticket.id and 'Change' or 'Set'} Properties</legend>
          <table>
            <tr>
              <th><label for="field-summary">Summary:</label></th>
              <td class="fullrow" colspan="3">
                <input type="text" id="field-summary" name="field_summary" value="${ticket.summary}"
                  size="70" />
              </td>
            </tr>
            <py:if test="'TICKET_ADMIN' in perm">
              <tr>
                <th><label for="field-reporter">Reporter:</label></th>
                <td class="fullrow" colspan="3">
                  <input type="text" id="field-reporter" name="field_reporter"
                    value="${ticket.reporter}" size="70" />
                </td>
              </tr>
            </py:if>
            <py:if test="'TICKET_ADMIN' in perm or not ticket.id">
              <tr>
                <th><label for="field-description">Description:</label></th>
                <td class="fullrow" colspan="3">
                  <textarea id="field-description" name="field_description" class="wikitext"
                    rows="10" cols="68" py:content="ticket.description"></textarea>
                </td>
              </tr>
            </py:if>
            <tr py:for="row in group(fields, 2, lambda f: f.type != 'textarea')"
                py:with="fullrow = len(row) == 1">
              <py:for each="idx, field in enumerate(row)">
                <th class="col${idx + 1}" py:if="idx == 0 or not fullrow">
                  <label for="field-${field.name}" py:if="field"
                         py:strip="field.type == 'radio'">${field.label or field.name}:</label>
                </th>
                <td class="col${idx + 1}" py:if="idx == 0 or not fullrow"
                    py:attrs="{'colspan': fullrow and 3 or None}">
                  <py:choose test="field.type" py:if="field">
                    <select py:when="'select'" id="field-${field.name}" name="field_${field.name}">
                      <option py:if="field.get('optional')"></option>
                      <option py:for="option in field.options"
                              selected="${ticket[field.name] == option or None}"
                              py:content="option"></option>
                    </select>
                    <textarea py:when="'textarea'" id="field-${field.name}" name="field_${field.name}"
                              cols="${field.width}" rows="${field.height}"
                              py:content="ticket[field.name]"></textarea>
                    <span py:when="'checkbox'">
                      <input type="checkbox" id="field-${field.name}" name="field_${field.name}"
                             checked="${ticket[field.name] == '1' and 'checked' or None}" value="1" />
                      <input type="hidden" name="field_checkbox_${field.name}" value="1" />
                    </span>
                    <label py:when="'radio'"
                           py:for="idx, option in enumerate(field.options)">
                      <input type="radio" name="field_${field.name}" value="${option}"
                             checked="${ticket[field.name] == option or None}" />
                      ${option}
                    </label>
                    <input py:otherwise="" type="text" id="field-${field.name}"
                           name="field_${field.name}" value="${ticket[field.name]}" />
                  </py:choose>
                </td>
              </py:for>
            </tr>
          </table>

        </fieldset>

        <py:choose test="not value_of('actions') or actions == ['leave']">

          <input py:when="True" type="hidden" name="action" value="leave" />

          <fieldset py:otherwise="" id="action" py:with="action = value_of('action', 'leave')">
            <legend>Action</legend>
            <py:for each="button in filter(None, [
              ('leave', 'leave as ' + ticket.status),
              ('accept' in actions and ('accept', 'accept ticket') or None),
              ('reopen' in actions and ('reopen', 'reopen ticket') or None),
              ('resolve' in actions and ('resolve', '', 'as', value_of('resolve_resolution'),
                [f for f in fields if f.name == 'resolution'][0].options) or None),
              ('reassign' in actions and ('reassign', '', 'to', value_of('reassign_owner'),
                [f for f in fields if f.name == 'owner'][0].options) or None)
            ])" py:with="name = button[0]; label = button[1] or button[0]">
              <input type="radio" id="$name" name="action" value="$name"
                     checked="${action == name and 'checked' or None}" />
              <label for="$name">$label</label>
              <label py:if="len(button) > 2" for="${name}_choice"
                     py:with="sublabel, subval, suboptions = button[2:]"
                     py:choose="">
                ${sublabel}:
                <select py:when="suboptions" size="1" id="${name}_choice"
                        name="${name}_choice">
                  <option py:for="option in suboptions"
                          selected="${option == subval or None}"
                          py:content="option" />
                </select>
                <input py:otherwise="" type="text" id="${name}_choice"
                       name="${name}_choice" size="40" value="$subval" />
              </label>
              <br />
            </py:for>
          </fieldset>
        </py:choose>

        <p py:if="value_of('can_attach')">
          <label>
            <input type="checkbox" name="attachment" checked="${attachment or None}" />
            I have files to attach to this ticket
          </label>
        </p>
        <div class="buttons">
          <input py:if="not ticket.id" type="hidden" name="field_status" value="new" />
          <input type="hidden" py:if="defined('timestamp')" name="ts" value="${timestamp}" />
          <input type="hidden" py:if="defined('replyto')" name="replyto" value="${replyto}" />
          <input type="hidden" py:if="defined('cnum')" name="cnum" value="${cnum}" />
          <input type="submit" name="preview" value="Preview" accesskey="r" />&nbsp;
          <input type="submit" py:attrs="ticket.id and {'value':'Submit changes'} or {'value':'Create ticket'}" />
        </div>

      </form>

      <div id="help">
        <strong>Note:</strong> See
        <a href="${href.wiki('TracTickets')}">TracTickets</a> for help on using
        tickets.
      </div>
    </div>
  </body>
</html>
